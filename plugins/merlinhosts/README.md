# 梅林路由Hosts插件

## 功能描述

通过SSH连接定时将本地Hosts同步至华硕梅林路由器，支持密码和密钥认证。

## 主要优化内容

### 1. 添加SSH连接功能
- 支持通过SSH连接到梅林路由器
- 实现真正的远程文件操作，替代原有的模拟操作
- 添加连接超时和错误处理机制

### 2. 多种认证方式
- **密码认证**：使用用户名和密码登录
- **密钥认证**：使用SSH私钥文件认证
- **混合认证**：优先使用私钥，失败时回退到密码认证

### 3. 完善的错误处理
- 添加配置验证（IP地址、用户名等必填项检查）
- paramiko库依赖检查
- SSH连接失败重试机制
- 详细的日志记录

### 4. 安全性增强
- 自动备份现有hosts.add文件
- 安全的文件传输（SFTP）
- 连接后自动关闭SSH会话

### 5. 用户界面优化
- 添加路由器连接配置项
- 清晰的配置说明和提示
- 警告信息提醒用户注意事项

## 配置说明

### 必填配置
- **路由器IP地址**：梅林路由器的IP地址（如：192.168.1.1）
- **用户名**：路由器登录用户名（通常为admin）
- **密码** 或 **私钥文件路径**：至少配置一种认证方式

### 可选配置
- **SSH端口**：默认22
- **私钥文件路径**：如果使用密钥认证
- **忽略的IP或域名**：不需要同步的条目
- **执行周期**：cron表达式，默认每天早上6点

## 使用前准备

1. **开启梅林路由器SSH服务**
   - 登录路由器管理界面
   - 进入「系统管理」->「系统设置」
   - 开启「Enable SSH」

2. **确保网络连接正常**
   - MoviePilot服务器能够访问路由器IP
   - SSH端口未被防火墙阻挡

## 工作原理

1. 读取本地hosts文件（/etc/hosts 或 Windows系统hosts文件）
2. 过滤和格式化hosts条目（忽略IPv6、回环地址等）
3. 通过SSH连接到梅林路由器
4. 备份现有的/jffs/configs/hosts.add文件
5. 写入新的hosts内容到hosts.add文件
6. 重启dnsmasq服务使配置生效
7. 关闭SSH连接

## 注意事项

- 插件会覆盖路由器上的hosts.add文件，请确保没有其他重要配置
- 建议先在测试环境验证功能正常后再在生产环境使用
- 如果使用密钥认证，请确保私钥文件路径正确且有读取权限
- 路由器重启后hosts配置会保持，但如果恢复出厂设置会丢失

## 版本历史

### v1.0
- 添加SSH连接功能，支持密码和SSH密钥认证
- 增强安全性和稳定性（自动备份、SFTP传输、重试机制）
- 优化配置界面，新增路由器IP、SSH端口、用户名、密码、私钥文件路径等配置项
- 技术改进：代码结构优化、配置验证、错误处理、日志输出