<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史记录导入导出</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.0/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: border-color 0.3s;
        }
        .file-upload-area.dragover {
            border-color: #1976d2;
            background-color: #f5f5f5;
        }
        .export-card {
            margin-bottom: 20px;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app>
            <v-main>
                <v-container>
                    <v-row>
                        <v-col cols="12">
                            <h1 class="text-h4 mb-4">历史记录导入导出</h1>
                        </v-col>
                    </v-row>

                    <!-- 导出功能 -->
                    <v-row>
                        <v-col cols="12" md="6">
                            <v-card class="export-card">
                                <v-card-title>
                                    <v-icon class="mr-2">mdi-export</v-icon>
                                    导出历史记录
                                </v-card-title>
                                <v-card-text>
                                    <v-btn 
                                        color="primary" 
                                        block 
                                        class="mb-3"
                                        :loading="exportAllLoading"
                                        @click="exportAll"
                                    >
                                        <v-icon left>mdi-database-export</v-icon>
                                        导出所有历史记录
                                    </v-btn>
                                    <v-btn 
                                        color="secondary" 
                                        block
                                        :loading="exportTvLoading"
                                        @click="exportTv"
                                    >
                                        <v-icon left>mdi-television</v-icon>
                                        按电视剧分别导出
                                    </v-btn>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <!-- 导入功能 -->
                        <v-col cols="12" md="6">
                            <v-card class="export-card">
                                <v-card-title>
                                    <v-icon class="mr-2">mdi-import</v-icon>
                                    导入历史记录
                                </v-card-title>
                                <v-card-text>
                                    <div 
                                        class="file-upload-area"
                                        :class="{ dragover: isDragOver }"
                                        @dragover.prevent="isDragOver = true"
                                        @dragleave.prevent="isDragOver = false"
                                        @drop.prevent="handleFileDrop"
                                        @click="$refs.fileInput.click()"
                                    >
                                        <v-icon size="48" color="grey">mdi-cloud-upload</v-icon>
                                        <p class="mt-2">点击或拖拽JSON文件到此处</p>
                                        <p class="text-caption text-grey">支持导入历史记录JSON文件</p>
                                    </div>
                                    <input 
                                        ref="fileInput" 
                                        type="file" 
                                        accept=".json" 
                                        style="display: none" 
                                        @change="handleFileSelect"
                                    >
                                    <v-btn 
                                        v-if="selectedFile"
                                        color="success" 
                                        block 
                                        class="mt-3"
                                        :loading="importLoading"
                                        @click="importHistory"
                                    >
                                        <v-icon left>mdi-upload</v-icon>
                                        导入 {{ selectedFile.name }}
                                    </v-btn>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- 导出文件列表 -->
                    <v-row>
                        <v-col cols="12">
                            <v-card>
                                <v-card-title>
                                    <v-icon class="mr-2">mdi-file-document-multiple</v-icon>
                                    导出文件列表
                                    <v-spacer></v-spacer>
                                    <v-btn 
                                        icon 
                                        @click="loadExportFiles"
                                        :loading="filesLoading"
                                    >
                                        <v-icon>mdi-refresh</v-icon>
                                    </v-btn>
                                </v-card-title>
                                <v-card-text>
                                    <div class="file-list">
                                        <v-list v-if="exportFiles.length > 0">
                                            <v-list-item 
                                                v-for="file in exportFiles" 
                                                :key="file.filename"
                                            >
                                                <v-list-item-content>
                                                    <v-list-item-title>{{ file.filename }}</v-list-item-title>
                                                    <v-list-item-subtitle>
                                                        大小: {{ formatFileSize(file.size) }} | 
                                                        创建时间: {{ file.created }}
                                                    </v-list-item-subtitle>
                                                </v-list-item-content>
                                                <v-list-item-action>
                                                    <v-btn 
                                                        icon 
                                                        color="primary"
                                                        @click="downloadFile(file.filename)"
                                                    >
                                                        <v-icon>mdi-download</v-icon>
                                                    </v-btn>
                                                </v-list-item-action>
                                            </v-list-item>
                                        </v-list>
                                        <v-alert 
                                            v-else 
                                            type="info" 
                                            variant="tonal"
                                        >
                                            暂无导出文件
                                        </v-alert>
                                    </div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- 消息提示 -->
                    <v-snackbar 
                        v-model="snackbar.show" 
                        :color="snackbar.color"
                        :timeout="5000"
                    >
                        {{ snackbar.text }}
                        <template v-slot:actions>
                            <v-btn 
                                color="white" 
                                variant="text" 
                                @click="snackbar.show = false"
                            >
                                关闭
                            </v-btn>
                        </template>
                    </v-snackbar>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.0/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.0/dist/vuetify.min.js"></script>
    <script>
        const { createApp } = Vue;
        const { createVuetify } = Vuetify;

        const vuetify = createVuetify({
            theme: {
                defaultTheme: 'light'
            }
        });

        createApp({
            data() {
                return {
                    exportAllLoading: false,
                    exportTvLoading: false,
                    importLoading: false,
                    filesLoading: false,
                    isDragOver: false,
                    selectedFile: null,
                    exportFiles: [],
                    snackbar: {
                        show: false,
                        text: '',
                        color: 'success'
                    }
                }
            },
            mounted() {
                this.loadExportFiles();
            },
            methods: {
                async exportAll() {
                    this.exportAllLoading = true;
                    try {
                        const response = await fetch('/api/v1/plugin/HistoryImportExport/export_all', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showMessage(result.message, 'success');
                            this.loadExportFiles();
                        } else {
                            this.showMessage(result.message, 'error');
                        }
                    } catch (error) {
                        this.showMessage('导出失败: ' + error.message, 'error');
                    } finally {
                        this.exportAllLoading = false;
                    }
                },
                async exportTv() {
                    this.exportTvLoading = true;
                    try {
                        const response = await fetch('/api/v1/plugin/HistoryImportExport/export_tv', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showMessage(result.message, 'success');
                            this.loadExportFiles();
                        } else {
                            this.showMessage(result.message, 'error');
                        }
                    } catch (error) {
                        this.showMessage('导出失败: ' + error.message, 'error');
                    } finally {
                        this.exportTvLoading = false;
                    }
                },
                async importHistory() {
                    if (!this.selectedFile) {
                        this.showMessage('请选择要导入的文件', 'warning');
                        return;
                    }
                    
                    this.importLoading = true;
                    try {
                        const formData = new FormData();
                        formData.append('file', this.selectedFile);
                        
                        const response = await fetch('/api/v1/plugin/HistoryImportExport/import_history', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`
                            },
                            body: formData
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            this.showMessage(result.message, 'success');
                            this.selectedFile = null;
                            this.$refs.fileInput.value = '';
                        } else {
                            this.showMessage(result.message, 'error');
                        }
                    } catch (error) {
                        this.showMessage('导入失败: ' + error.message, 'error');
                    } finally {
                        this.importLoading = false;
                    }
                },
                async loadExportFiles() {
                    this.filesLoading = true;
                    try {
                        const response = await fetch('/api/v1/plugin/HistoryImportExport/list_exports', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token') || sessionStorage.getItem('token')}`
                            }
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            this.exportFiles = result.data;
                        } else {
                            this.showMessage(result.message, 'error');
                        }
                    } catch (error) {
                        this.showMessage('获取文件列表失败: ' + error.message, 'error');
                    } finally {
                        this.filesLoading = false;
                    }
                },
                downloadFile(filename) {
                    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                    const link = document.createElement('a');
                    link.href = `/api/v1/plugin/HistoryImportExport/download/${filename}`;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // 添加认证头
                    fetch(link.href, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }).then(response => {
                        if (response.ok) {
                            return response.blob();
                        }
                        throw new Error('下载失败');
                    }).then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }).catch(error => {
                        this.showMessage('下载失败: ' + error.message, 'error');
                    });
                },
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/json') {
                        this.selectedFile = file;
                    } else {
                        this.showMessage('请选择JSON格式的文件', 'warning');
                    }
                },
                handleFileDrop(event) {
                    this.isDragOver = false;
                    const file = event.dataTransfer.files[0];
                    if (file && file.type === 'application/json') {
                        this.selectedFile = file;
                    } else {
                        this.showMessage('请选择JSON格式的文件', 'warning');
                    }
                },
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                showMessage(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                }
            }
        }).use(vuetify).mount('#app');
    </script>
</body>
</html>